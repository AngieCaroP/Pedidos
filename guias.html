<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial de Gu√≠as</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .contenedor-filtros {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input[type="text"], input[type="date"] {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      width: 200px;
      font-size: 14px;
    }
    input[type="text"]:focus, input[type="date"]:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    .card-dia {
      background-color: #fff;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 15px;
      page-break-inside: avoid;
    }
    .card-dia h3 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
      color: #333;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    .plataforma {
      margin-top: 15px;
    }
    .plataforma h4 {
      margin: 0 0 8px 0;
      color: #444;
      font-size: 1em;
    }
    .guia {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9f9f9;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }
    .guia span {
      flex-grow: 1;
      margin-right: 10px;
      word-break: break-word;
    }
    button.copiar {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.2s;
    }
    button.copiar:hover {
      background-color: #0069d9;
    }
    .acciones {
      margin-top: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .acciones button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .exportar { 
      background-color: #28a745; 
      color: white; 
    }
    .exportar:hover {
      background-color: #218838;
    }
    .exportarExcel { 
      background-color: #17a2b8; 
      color: white; 
    }
    .exportarExcel:hover {
      background-color: #138496;
    }
    .exportarPdf { 
      background-color: #6c757d; 
      color: white; 
    }
    .exportarPdf:hover {
      background-color: #5a6268;
    }
    .limpiar { 
      background-color: #dc3545; 
      color: white; 
    }
    .limpiar:hover {
      background-color: #c82333;
    }
    .btn-volver {
      background-color: #ffc107;
      color: #212529;
    }
    .btn-volver:hover {
      background-color: #e0a800;
    }
    
    /* Estilos para mensaje cuando no hay gu√≠as */
    .sin-guias {
      text-align: center;
      padding: 30px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      color: #6c757d;
    }
    
    /* Estilos espec√≠ficos para PDF */
    .pdf-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .pdf-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .pdf-subtitle {
      font-size: 14px;
      color: #666;
    }
  </style>
  
  <!-- Agregar estas bibliotecas -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>üìò Historial de Gu√≠as</h1>

  <div class="contenedor-filtros">
    <input type="text" id="buscarGuia" placeholder="Buscar por texto..." title="Buscar en el texto de las gu√≠as">
    <input type="date" id="filtrarFecha" title="Filtrar por fecha espec√≠fica">
  </div>

  <div id="historialGuias">
    <!-- Tarjetas por d√≠a aparecer√°n aqu√≠ -->
  </div>

  <div class="acciones">
    <button class="exportar">‚¨á Exportar como TXT</button>
    <button class="exportarExcel">‚¨á Exportar como Excel</button>
    <button class="exportarPdf">‚¨á Exportar como PDF</button>
    <!--<button class="limpiar">üóë Limpiar historial</button>-->
    <button onclick="window.location.href='index.html'" class="btn-volver">
      ‚Üê Volver al inicio
    </button>
  </div>

  <script>
    // Inicializar jsPDF
    const { jsPDF } = window.jspdf;
    
    // Obtener gu√≠as del localStorage
    const guias = JSON.parse(localStorage.getItem('guiasGeneradas')) || [];
    const historialDiv = document.getElementById('historialGuias');
    const inputBuscar = document.getElementById('buscarGuia');
    const inputFecha = document.getElementById('filtrarFecha');

    // Funci√≥n para renderizar el historial con filtros
    function renderHistorial(filtrarTexto = '', filtrarPorFecha = '') {
      historialDiv.innerHTML = '';

      // Aplicar filtros
      const guiasFiltradas = guias.filter(g => {
        const coincideTexto = g.texto.toLowerCase().includes(filtrarTexto.toLowerCase());
        const coincideFecha = filtrarPorFecha ? g.fecha === filtrarPorFecha : true;
        return coincideTexto && coincideFecha;
      });

      // Mostrar mensaje si no hay gu√≠as
      if (guiasFiltradas.length === 0) {
        const mensaje = document.createElement('div');
        mensaje.className = 'sin-guias';
        mensaje.innerHTML = `
          <p>No se encontraron gu√≠as ${filtrarTexto || filtrarPorFecha ? 'que coincidan con los filtros' : 'en el historial'}.</p>
          <p>Genera nuevas gu√≠as desde la p√°gina principal.</p>
        `;
        historialDiv.appendChild(mensaje);
        return;
      }

      // Agrupar por fecha
      const guiasPorFecha = {};
      guiasFiltradas.forEach(g => {
        if (!guiasPorFecha[g.fecha]) guiasPorFecha[g.fecha] = [];
        guiasPorFecha[g.fecha].push(g);
      });

      // Ordenar fechas de m√°s reciente a m√°s antigua
      Object.keys(guiasPorFecha).sort((a, b) => new Date(b) - new Date(a)).forEach(fecha => {
        const card = document.createElement('div');
        card.className = 'card-dia';
        card.innerHTML = `<h3>üìÖ ${fecha}</h3>`;

        // Agrupar por plataforma (Facebook, TikTok)
        const plataformas = {
          'Facebook': { guias: [], color: '#4267B2' },
          'TikTok': { guias: [], color: '#FE2C55' },
          'Otras': { guias: [], color: '#007bff' }
        };

        guiasPorFecha[fecha].forEach(g => {
          // Usamos la plataforma guardada o la detectamos del texto
          let plataforma = g.plataforma === 'F' ? 'Facebook' : 
                          g.plataforma === 'T' ? 'TikTok' : 'Otras';
          
          if (plataforma === 'Otras') {
            // Si no estaba guardada, intentamos detectar del texto
            const primeraLetra = g.texto.split('-')[1]?.charAt(0)?.toUpperCase();
            if (primeraLetra === 'F') plataforma = 'Facebook';
            else if (primeraLetra === 'T') plataforma = 'TikTok';
          }
          
          plataformas[plataforma].guias.push(g.texto);
        });

        // Crear secciones por plataforma
        for (const [nombrePlataforma, datos] of Object.entries(plataformas)) {
          if (datos.guias.length === 0) continue;

          const divP = document.createElement('div');
          divP.className = 'plataforma';
          divP.innerHTML = `<h4 style="color: ${datos.color}">${nombrePlataforma}</h4>`;

          // A√±adir cada gu√≠a
          datos.guias.forEach(texto => {
            const gDiv = document.createElement('div');
            gDiv.className = 'guia';
            gDiv.style.borderLeftColor = datos.color;
            
            const span = document.createElement('span');
            span.textContent = texto;

            const btn = document.createElement('button');
            btn.className = 'copiar';
            btn.textContent = 'üìã Copiar';
            btn.style.backgroundColor = datos.color;
            btn.onclick = () => {
              navigator.clipboard.writeText(texto).then(() => {
                btn.textContent = '‚úÖ Copiado!';
                setTimeout(() => btn.textContent = 'üìã Copiar', 2000);
              });
            };

            gDiv.appendChild(span);
            gDiv.appendChild(btn);
            divP.appendChild(gDiv);
          });

          card.appendChild(divP);
        }

        historialDiv.appendChild(card);
      });
    }

    // Eventos para los filtros
    inputBuscar.addEventListener('input', () => {
      renderHistorial(inputBuscar.value, inputFecha.value);
    });

    inputFecha.addEventListener('change', () => {
      renderHistorial(inputBuscar.value, inputFecha.value);
    });

    // ... (mantener el resto de funciones igual) ...

    // Renderizar inicialmente TODAS las gu√≠as
    document.addEventListener('DOMContentLoaded', () => {
      renderHistorial();
    });
  </script>
</body>
</html>